import java.sql.*;
import java.util.Random;

public class main {
    private static Connection connection;
    private static Statement statement;
    private static ResultSet resultSet;
    static Random rand = new Random();

    //WORKING
    //Initializing the connection with the database and setting up the connect statement
    private static void initialize() {
        try {
            // Initialize  connection
            connection = DriverManager.getConnection(
                    "jdbc:mysql://127.0.0.1:3307/roombookingsystem1",
                    "root",
                    ""
            );
            // Statement Object
            statement = connection.createStatement();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    //WORKING
    //This authenticateUser is for login when need to check the userID and password
    public static boolean userLoginCheck(String userID, String password) {
        initialize();
        try {
            // Execute the query to check if the userID and password combination exists (For Login basic)
            String query = "SELECT * FROM `User Login` WHERE `User ID` = '" + userID + "' AND `Password` = '" + password + "'";
            resultSet = statement.executeQuery(query);

            // If there is a result then can login
            return resultSet.next();
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        } finally {
            // Close the result set, statement, and connection
            try {
                if (resultSet != null) resultSet.close();
                if (statement != null) statement.close();
                if (connection != null) connection.close();

            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }

    //CALL WHEN LOGIN (NOT TESTED)
    public static boolean login(String userID, String password) {
        initialize();

        // Check if it's a valid in the database system
        if (userLoginCheck(userID, password)) {
            //Sets the token for current login session
            String query = "UPDATE `User Login` SET `OTPKey` = '" + createToken() + "' WHERE `User ID` = '" + userID + "'";
            try {
                // Execute the update query
                int rowsUpdated = statement.executeUpdate(query);
                // Check if the update was successful
                if (rowsUpdated > 0) {
                    System.out.println("OTPKey updated successfully");
                    return true; // Return true only if update was successful
                } else {
                    System.out.println("No rows updated");
                }
            } catch (SQLException e) {
                System.err.println("Error updating OTPKey: " + e.getMessage());
                e.printStackTrace();
            } finally {
                // Close the connection and statement
                try {
                    if (statement != null) {
                        statement.close();
                    }
                    if (connection != null) {
                        connection.close();
                    }
                } catch (SQLException e) {
                    System.err.println("Error closing connection: " + e.getMessage());
                    e.printStackTrace();
                }
            }
        }
        return false; // Return false if userLoginCheck fails or no rows were updated
    }


    //CALL FOR VERIFICATION - TEMPORARY VERIFICATION FUNCTION (NOT TESTED)
    public static boolean authentication(String userID, int key) {
        initialize();

        try {
            String query = "SELECT `OTPKey` FROM `User Login` WHERE `User ID` = '" + userID + "'";
            resultSet = statement.executeQuery(query);

            // Check if the resultSet has any rows
            if (resultSet.next()) {
                // Retrieve the value of the OTPKey column
                int otpKey = resultSet.getInt("OTPKey");

                // Compare the retrieved OTPKey with the provided key
                if (otpKey == key) {
                    return true;        //Verify complete, proceed to login
                } else {
                    return false;
                }
            } else {
                return false;
            }
        } catch (SQLException e) {
            System.err.println("Error verifying OTPKey: " + e.getMessage());
            e.printStackTrace();
            return false;
        } finally {
            // Close the connection and statement
            try {
                if (statement != null) {
                    statement.close();
                }
                if (connection != null) {
                    connection.close();
                }
            } catch (SQLException e) {
                System.err.println("Error closing connection: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }


    //Creates a random token
    public static int createToken(){
        int key = rand.nextInt(1000,9999);
        return key;
    }


    //Edit the existing password
    public static boolean editPassword(String userID, String newPassword) {
        initialize();

        try {
            // Construct the update query to change the password
            String query = "UPDATE `User Login` SET `Password` = '" + newPassword + "' WHERE `User ID` = '" + userID + "'";

            // Execute the update query
            int rowsUpdated = statement.executeUpdate(query);

            // Check if the update was successful
            if (rowsUpdated > 0) {
                System.out.println("Password updated successfully");
                return true;
            } else {
                System.out.println("No rows updated");
                return false;
            }
        } catch (SQLException e) {
            System.err.println("Error updating password: " + e.getMessage());
            e.printStackTrace();
            return false;
        } finally {
            // Close the connection and statement
            try {
                if (statement != null) {
                    statement.close();
                }
                if (connection != null) {
                    connection.close();
                }
            } catch (SQLException e) {
                System.err.println("Error closing connection: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }

    //NOT TESTED
    public static boolean viewRoomAvailability(String roomID, Date date, Time startTime, Time endTime) {
        initialize();

        try {
            // Construct the query to check for overlapping bookings
            String query = "SELECT COUNT(*) AS count FROM `Booking ID description`" +
                    "WHERE `Room ID` = ? AND `Date` = ?" +
                    "AND ((`Start Time` BETWEEN ? AND ?) OR (`End Time` BETWEEN ? AND ?))";

            // Prepare the statement
            PreparedStatement preparedStatement = connection.prepareStatement(query);

            // Set parameters for the prepared statement
            preparedStatement.setString(1, roomID);
            preparedStatement.setDate(2, date);
            preparedStatement.setTime(3, startTime);
            preparedStatement.setTime(4, endTime);
            preparedStatement.setTime(5, startTime);
            preparedStatement.setTime(6, endTime);

            // Execute the query
            ResultSet resultSet = preparedStatement.executeQuery();

            // Check if there are any overlapping bookings
            if (resultSet.next()) {
                int count = resultSet.getInt("count");
                return count == 0; // If count is 0, there are no overlapping bookings
            } else {
                return false; // Error occurred or no result
            }
        } catch (SQLException e) {
            System.err.println("Error checking room availability: " + e.getMessage());
            e.printStackTrace();
            return false;
        } finally {
            // Close the connection and statement
            try {
                if (statement != null) {
                    statement.close();
                }
                if (connection != null) {
                    connection.close();
                }
            } catch (SQLException e) {
                System.err.println("Error closing connection: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }




    // Retrieve the last booking ID from the database (USED IN BELOW FUNCTION)
    private static int getLastBookingRequestID() throws SQLException {
        int lastBookingID = 0;
        String query = "SELECT MAX(`Request ID`) AS last_booking_id FROM `Booking Request`";
        try (ResultSet resultSet = statement.executeQuery(query)) {
            if (resultSet.next()) {
                lastBookingID = resultSet.getInt("last_booking_id");
            }
        }
        return lastBookingID;
    }


    // Create a new booking request
    public static void createBookingRequest(String userID, String roomID, String description, Date date, Time sTime, Time eTime) {
        initialize();
        try {
            // Get the generated Booking ID
            int bookingID = getLastBookingRequestID() + 1;

            // Insert into Booking Request table
            String insertRequestQuery = "INSERT INTO `Booking Request` (`Request ID`, `User ID`, `Room ID`) VALUES (?, ?, ?)";
            PreparedStatement requestStatement = connection.prepareStatement(insertRequestQuery);
            requestStatement.setInt(1, bookingID);
            requestStatement.setString(2, userID);
            requestStatement.setString(3, roomID);
            requestStatement.executeUpdate();

            // Insert into Booking Request Description table
            String insertDescriptionQuery = "INSERT INTO `Booking Request Description` (`Request ID`, `Description`, `Date`, `Start Time`, `End Time`) VALUES (?, ?, ?, ?)";
            PreparedStatement descriptionStatement = connection.prepareStatement(insertDescriptionQuery, Statement.RETURN_GENERATED_KEYS);
            descriptionStatement.setInt(1, bookingID);
            descriptionStatement.setString(2, description);
            descriptionStatement.setDate(3, date);
            descriptionStatement.setTime(4, sTime);
            descriptionStatement.setTime(5, eTime);
            descriptionStatement.executeUpdate();


            System.out.println("Booking request created successfully.");
        } catch (SQLException e) {
            e.printStackTrace();
            System.err.println("Error creating booking request: " + e.getMessage());
        } finally {
            // Close the connection and statement
            try {
                if (statement != null) {
                    statement.close();
                }
                if (connection != null) {
                    connection.close();
                }
            } catch (SQLException e) {
                System.err.println("Error closing connection: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }




//TEST AREA






    public static void main(String[] args) {
        testUserLoginCheck();
        testLogin();
        testAuthentication();
        testEditPassword();
        testViewRoomAvailability();
        testCreateBookingRequest();
    }

    public static void testUserLoginCheck() {
        System.out.println("Testing userLoginCheck...");

        boolean result1 = main.userLoginCheck("user123", "password123");
        assert result1 : "Test case 1 failed";

        boolean result2 = main.userLoginCheck("invalidUser", "invalidPassword");
        assert !result2 : "Test case 2 failed";

        System.out.println("userLoginCheck tests passed.");
    }

    public static void testLogin() {
        System.out.println("Testing login...");

        boolean result1 = main.login("user123", "password123");
        assert result1 : "Test case 1 failed";

        boolean result2 = main.login("invalidUser", "invalidPassword");
        assert !result2 : "Test case 2 failed";

        System.out.println("login tests passed.");
    }

    public static void testAuthentication() {
        System.out.println("Testing authentication...");

        boolean result1 = main.authentication("user123", 1234);
        assert result1 : "Test case 1 failed";

        boolean result2 = main.authentication("user123", 4321);
        assert !result2 : "Test case 2 failed";

        System.out.println("authentication tests passed.");
    }

    public static void testEditPassword() {
        System.out.println("Testing editPassword...");

        boolean result1 = main.editPassword("user123", "newPassword123");
        assert result1 : "Test case 1 failed";

        boolean result2 = main.editPassword("invalidUser", "newPassword");
        assert !result2 : "Test case 2 failed";

        System.out.println("editPassword tests passed.");
    }

    public static void testViewRoomAvailability() {
        System.out.println("Testing viewRoomAvailability...");

        boolean result1 = main.viewRoomAvailability("room123", Date.valueOf("2024-03-10"), Time.valueOf("09:00:00"), Time.valueOf("10:00:00"));
        assert result1 : "Test case 1 failed";

        boolean result2 = main.viewRoomAvailability("room123", Date.valueOf("2024-03-10"), Time.valueOf("08:00:00"), Time.valueOf("09:30:00"));
        assert !result2 : "Test case 2 failed";

        System.out.println("viewRoomAvailability tests passed.");
    }

    public static void testCreateBookingRequest() {
        System.out.println("Testing createBookingRequest...");

        // Assuming successful execution indicates test passed
        main.createBookingRequest("user123", "room123", "Meeting", Date.valueOf("2024-03-15"), Time.valueOf("10:00:00"), Time.valueOf("11:00:00"));

        System.out.println("createBookingRequest tests passed.");
    }
}



